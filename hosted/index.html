<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" type="text/css" href="/assets/style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <script src="./socket.io/socket.io.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script type="text/babel" >
        "use strict";
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let firstCanvas = document.getElementById("firstCanvas");
        let firstCtx = firstCanvas.getContext("2d");
        let secondCanvas = document.getElementById("secondCanvas");
        let secondCtx = secondCanvas.getContext("2d");
        let dragging = false;
        let user;
        let isVoter = false;
        let maxInk = 200;
        let currentInk = maxInk;
        let outOfInk = false;
        let inkwell = document.getElementById("inkwell");
        //make the first canvas to be shown first
        let isFirstShown = false;
        let secondHasBeenShown = false;
        //html things
        let enterRoomButton = document.getElementById("roomEnter");
        let room;
        let roomTextBox = document.getElementById("room");
        let userTextBox = document.getElementById("username");
        let startGameButton = document.getElementById("startGame");
        let startNewGameButton = document.getElementById("startNewGame");
        let guess;
        let enterGuessButton = document.getElementById("guessButton");
        let guessTextBox = document.getElementById("guessText");
        let score;
        let correctUsersTextBox = document.getElementById("correctUsers");

        const socket = io.connect();

        const connectSocket = (e) => {
            socket.on('connect', () => {
                console.log('waiting for room to enter');
            });

            socket.on('draw', (data) => {
                console.log(data);
                handleMessage(data);
            });
            
            socket.on('UI', (data) => {
               resetUI(data); 
            });
            
            socket.on('doDisconnect', (data) => {
               disconnect(); 
            });
            
            socket.on('failedToJoin', (data) => {
               failedToJoinGame(); 
            });
            
            socket.on('newGame', (data) => {
               prepareNewGame(data); 
            });
            
            socket.on('startCountdown', () => {
               startCountdown(5); 
            });
            
            socket.on('nextDrawing', (data) => {
               nextDrawing(data); 
            });
            
            socket.on('guessOutcome', (data) => {
               guessOutcome(data); 
            });
            
            socket.on('endTheRound', () => {
               endTheRound(); 
            });
            
            socket.on('failedToStart', () => {
               failedToStart(); 
            });
            
            socket.on('endLobby', (data) => {
               endLobby(data); 
            });
        };

        //triggered when player cannot start because lobby is not full enough
        const failedToStart = () => {
          document.getElementById("lobbyText").innerHTML = "You need at least 3 players to start a game!";  
        };

        //triggered when player attempts to join a game thats currently running or full lobby
        const failedToJoinGame = () => {
            console.log("Failed to join " + room);
            //reverse all UI changes, join failed
            roomTextBox.disabled = false;
            roomTextBox.style.display = "inline-block";
            userTextBox.disabled = false;
            userTextBox.style.display = "inline-block";
            document.getElementById("room").value = null;
            room = null;
            enterRoomButton.style.display = 'inline';
            startGameButton.style.visibility = 'hidden';
            document.getElementById("lobbyScreen").style.display = "none";
            document.getElementById("lobbyText").style.display = "none";
            document.getElementById("lobbySubtext").style.display = "none";
        };

        //called when player attempts to join a room
        const enterRoom = () => {
            room = document.getElementById("room").value;
            user = document.getElementById("username").value;
            //if username field is left blank, default to username "Player"
            if(user == "") {user = "Player";}
            console.log("username: " + user);
            //add numbers to the end to ensure seperate usernames
            user = user + `${(Math.floor((Math.random()*10000)) + 1)}`;
            console.log("username: " + user);
            console.log(room);
            if(room != null){
                const data = { userID: user, roomID: room };
                socket.emit('join', data);
            }
            //fix UI after game joined
            document.getElementById("roomSelectScreen").style.display = "none";
            document.getElementById("titleText").style.display = "none";
            document.getElementById("titleSubtext").style.display = "none";
            roomTextBox.disabled = true;
            roomTextBox.style.display = "none";
            userTextBox.disabled = true;
            userTextBox.style.display = "none";
            enterRoomButton.style.display = 'none';
            startGameButton.style.visibility = 'visible';
            document.getElementById("lobbyScreen").style.display = "block";
            document.getElementById("lobbyText").style.display = "inline";
            document.getElementById("lobbySubtext").style.display = "inline";
        };

        //prepares yourself and others for a new game
        const startNewGame = () => {
            const data = { userID: user, roomID: room };
            socket.emit('startNewGame', data);
        }

        //called at the start of a new round to reset
        const prepareNewGame = (data) => {
            //some css stuff
            startGameButton.style.visibility = "none";
            enterRoomButton.style.display = 'none';
            document.getElementById('voterText').style.display = "none";
            document.getElementById("lobbyScreen").style.display = "block";  
            document.getElementById("lobbyText").style.display = "inline";
            document.getElementById("lobbySubtext").style.display = "inline";
            startNewGameButton.style.visibility = "hidden";
            document.getElementById("answer").style.display = "none";
            document.getElementById("lobbyText").innerHTML = "Starting soon...";
            guessTextBox.disabled = false;
            guessTextBox.placeholder = "Enter Guess:";
            //reset all canvases, ink, and view shifters
            setCanvases();
            //after everything reset send start new game request to server (IF YOU'RE THE ONE WHO SENT THE REQUEST)
            if(data.userID == user){
                startGame();
            }
        }

        //called when player hits start game in a lobby
        const startGame = () => {
            const data = { userID: user, roomID: room };
            socket.emit('startGame', data);
            console.log("Sent start game request");
        };

        //the countdown called at the beginning of the game to signal a start
        const startCountdown = (currentNum) => {
            if(currentNum > 0){
                console.log(currentNum);
                document.getElementById("lobbyText").innerHTML = "Starting in " + currentNum + "...";
                currentNum--;
                setTimeout(function(){ startCountdown(currentNum) }, 1000);
            }
            else{
                document.getElementById("lobbyText").innerHTML = "Starting...";
            }
        };

        //begins to throw down
        const nextDrawing = (data) => {
            //checks to see if the client is a voter
            if(isVoter == true){
                //if the first canvas isn't shown drop it into place
                if(isFirstShown == false && secondHasBeenShown == false){
                    firstCanvas.style.transform = "translate(0px, 750px)";
                    firstCanvas.style.visibility = "visible";
                    isFirstShown = true;
                }
                //if the second canvas has been shown, but the first isn't on screen right now, rotate
                else if(isFirstShown == false){
                    secondCanvas.style.transform = "translate(-2000px, 750px)";
                    firstCanvas.style.transform = "translate(0px, 750px)";
                    firstCanvas.style.visibility = "visible";
                    setTimeout(function(){secondCanvas.style.visibility = "hidden";
                                         secondCanvas.style.transform = "translate(0, 0)";
                                         }, 1500);
                    isFirstShown = true;
                }
                //if the first canvas IS shown, slide it out of sight and drop the second canvas in
                else {
                    firstCanvas.style.transform = "translate(-2000px, 750px)";
                    secondCanvas.style.transform = "translate(0px, 750px)";
                    secondCanvas.style.visibility = "visible";
                    setTimeout(function(){firstCanvas.style.visibility = "hidden";
                                         firstCanvas.style.transform = "translate(0, 0)";
                                         }, 1500);
                    isFirstShown = false;
                    secondHasBeenShown = true;
                }
                
                guessTextBox.style.visibility = "visible";
                enterGuessButton.style.visibility = "visible";
                document.getElementById("voterText").style.visibility = "visible";
            }
            else{
                document.getElementById("answer").style.display = "block";
                document.getElementById("answer").innerHTML = "You have to draw: " + data.answerID;
            }
            
            //TODO: get rid of lobby screen
            document.getElementById("lobbyScreen").style.display = "none";
            document.getElementById("lobbyText").style.display = "none";
            document.getElementById("lobbySubtext").style.display = "none";
        };

        //This is where the guesses go to meet their fate, true is correct, false is incorrect
        const guessOutcome = (data) => {
            //if the current guess outcome is coming from yourself, display the CORRECT and WRONG text
            if(data.guessAnswer == true){
                if(data.userID == user){
                    score = score + 10;
                    guessTextBox.disabled = true;
                    guessTextBox.placeholder = "Correct!";
                    enterGuessButton.style.visibility = "hidden";
                    console.log(score);
                }
               if(data.drawerID == user){
                    score = score + 10;
                    console.log(score);
                }
                correctUsersTextBox.innerHTML += "<br>" + data.userID;
                //TODO: add scrollable text box with all user's wrong answers
            }
        };

        //method to make sure canvases are not blank after game has started
        const setCanvases = () => {
            //fix canvases
            firstCtx.fillStyle="white";
            firstCtx.fillRect(0,0,900, 600);
            
            secondCtx.fillStyle="white";
            secondCtx.fillRect(0,0,900, 600);
            
            ctx.fillStyle="white";
            ctx.fillRect(0,0,900, 600);
            //fix ink
            currentInk = maxInk + 1;
            useInk();
            //fix rotating canvases
            isFirstShown = false;
            secondHasBeenShown = false;
        }

        //changing the UI so voters and drawers have seperate experiences
        const resetUI = (data) => {
            console.log("IsFirst: " + data.first + ", " + "IsSecond: " + data.second);
            //check to see if this client is first or second
            if(data.first == user) {
                document.getElementById("playerRole").innerHTML = "You are a drawer.";
                document.getElementById("lobbySubtext").innerHTML = "You are a drawer.<br>Remember to use your ink carefully, you don't have much!";
                //remove voter elements
                guessTextBox.style.display = "none";
                guessTextBox.disabled = true;
                enterGuessButton.style.display = "none";
                firstCanvas.style.display = "none";
                secondCanvas.style.display = "none";
                document.getElementById("firstText").style.display = "none";
                document.getElementById("secondText").style.display = "none";
                //re-add drawing elements if new round and different role
                canvas.style.display = "inline";
                inkwell.style.display = "block";
                isVoter = false;
            }
            //set screen to be this way if they are the second drawer
            if(data.second == user) {
                document.getElementById("playerRole").innerHTML = "You are a drawer.";
                document.getElementById("lobbySubtext").innerHTML = "You are a drawer.<br>Remember to use your ink carefully, you don't have much!";
                //remove voter elements
                guessTextBox.style.display = "none";
                guessTextBox.disabled = true;
                enterGuessButton.style.display = "none";
                firstCanvas.style.display = "none";
                secondCanvas.style.display = "none";
                document.getElementById("firstText").style.display = "none";
                document.getElementById("secondText").style.display = "none";
                //re-add drawing elements if new round and different role
                canvas.style.display = "inline";
                inkwell.style.display = "block";
                isVoter = false;
            }
            //set this screen if they are a voter
            if(data.first != user && data.second != user) {
                document.getElementById("playerRole").innerHTML = "You are a voter.";
                document.getElementById("lobbySubtext").innerHTML = "You are a voter.<br>Try to guess what the drawers are inking up!<br>You get two seperate drawings to look at!";
                document.getElementById("firstText").innerHTML = data.first + "'s Picture";
                document.getElementById("secondText").innerHTML = data.second + "'s Picture";
                //remove drawing elements
                canvas.style.display = "none";
                inkwell.style.display = "none";
                isVoter = true;
                setCanvases();
                //re-add voter elements if new round and different role
                guessTextBox.style.display = "inline-block";
                guessTextBox.disabled = false;
                enterGuessButton.style.display = "inline-block";
                firstCanvas.style.display = "inline";
                secondCanvas.style.display = "inline";
                document.getElementById("firstText").style.display = "inline";
                document.getElementById("secondText").style.display = "inline";
            }
            
            startGameButton.style.visibility = 'hidden';
        };

        const enterGuess = () => {
            guess = guessTextBox.value;
            const data = { userID: user, roomID: room, guessID: guess };
            socket.emit('enterGuess', data);
            guessTextBox.value = null;
        };

        //when the round is over
        const endTheRound = () => {
          const data = { 
            userID: user,
            roomID: room,
            scoreID: score
          }
          socket.emit('sendScore', data);
        };

        const endLobby = (data) => {
            document.getElementById('voterText').style.display = "none";
            document.getElementById("lobbyScreen").style.display = "block";  
            document.getElementById("lobbyText").style.display = "block";
            //TODO: where to put leaderboard
            document.getElementById("lobbyText").innerHTML = "The winner is... " + data.winnerID + "!";
            document.getElementById("lobbySubtext").style.display = "block";
            document.getElementById("lobbySubtext").innerHTML = "With a score of " + data.topScoreID + "!";
            document.getElementById("lobbySubtext").innerHTML += "<br><br>You were " + user + ", " + "and got a score of " + score;
            document.getElementById("lobbySubtext").innerHTML += "<br><br><br>THIS IS THE ADVERTISMENT PAGE!";
            document.getElementById("lobbySubtext").innerHTML += "<br><br>ADVERTISMENT HERE!";
            startNewGameButton.style.visibility = 'visible';
        };

        const handleMessage = (data) => {

            let image = new Image();
            image.src = data.imgData;

            image.onload = () => {
                console.log("firstCheck: " + data.isFirst + "secondCheck: " + data.isSecond);
                //displays the drawers drawings on only one canvas
                if(data.isFirst == true){
                    firstCtx.save();
                    firstCtx.globalCompositeOperation = "source-over"; //this is default for canvas-->
                    firstCtx.drawImage(image, data.x, data.y, data.width, data.height);    
                    firstCtx.restore();
                }
                else{ 
                    if(data.isSecond == true){
                        secondCtx.save();
                        secondCtx.globalCompositeOperation = "source-over"; //this is default for canvas-->
                        secondCtx.drawImage(image, data.x, data.y, data.width, data.height);    
                        secondCtx.restore();
                    }
                }
            };
        }

        const init = () => {
        //Paint canvas white and update to clear any drawings from a past player
          ctx.fillStyle="white";
          ctx.fillRect(0,0,900, 600);
          doMouseout();
          //Hook up event listeners
		  canvas.onmousedown = doMousedown;
		  canvas.onmousemove = doMousemove;
		  canvas.onmouseup = doMouseup;
		  canvas.onmouseout = doMouseout;
          enterRoomButton.onclick = enterRoom;
          startGameButton.onclick = startGame;
          startNewGameButton.onclick = startNewGame;
          enterGuessButton.onclick = enterGuess;
            //add the enter key as a way of entering text
          roomTextBox.addEventListener("keyup", function(e) {
              event.preventDefault();
              if(event.keyCode == 13) {
                  enterRoomButton.click();
              }
          });
            //add the enter key as a way of entering text
          guessTextBox.addEventListener("keyup", function(e) {
              event.preventDefault();
              if(event.keyCode == 13) {
                  enterGuessButton.click();
              }
          });
            //clear the scoreboard
          score = 0;
          connectSocket();
        };

    const useInk = () => {
        //increment ink usage while player is dragging with mouse down
        currentInk--;
        if(currentInk <= 0) outOfInk = true;
        
        let ink = document.getElementById("emptyInk");
        //change the inkwell's content
        let width = currentInk / 2;
        ink.style.width = width + '%';
    }

	const doMousedown = (mouseData) => {
	    dragging = true;

	    //get location off mouse in cannvas coordinates
	    var mouse = getMouse(mouseData);
	     ctx.beginPath();
	     ctx.moveTo(mouse.x, mouse.y);
	}

    const doMousemove = (mouseData) => {
 	    //bail out if the mouse button is not down
 	    if (!dragging) return;

 	    //get location of mouse in canvas coordinates
 	    var mouse = getMouse(mouseData);

 	      ctx.strokeStyle = "black";
 	      ctx.lineWidth = 5;

 	      //draw a line to x,y of mouse
 	      ctx.lineTo(mouse.x, mouse.y);

        if(outOfInk == false){
 	      //stroke the line
 	      ctx.stroke();
        }
        
          //use Ink
        useInk();
    }

    const doMouseup = () => {
	   ctx.closePath();
       dragging = false;
            const data = {
                x: 0,
                y: 0,
                height: 600,
                width: 900, 
                imgData: canvas.toDataURL(),
                userID: user,
                roomID: room
            };
        socket.emit("update", data);
    }

	const doMouseout = () => {
       ctx.closePath();
	   dragging = false;
        const data = {
                x: 0,
                y: 0,
                height: 600,
                width: 900, 
                imgData: canvas.toDataURL(),
                userID: user,
                roomID: room
            };
        socket.emit("update", data);
	}
    
    //This method originally written by Tony Jefferson (IGM)
	const getMouse = (mouseData) => {
		var mouse = {}
		mouse.x = mouseData.pageX - mouseData.target.offsetLeft;
		mouse.y = mouseData.pageY - mouseData.target.offsetTop;
		return mouse;
	}
    
    //clear canvas and disconnect from server
    const disconnect = () => {
        ctx.fillStyle="white";
        ctx.fillRect(0,0,900, 600);
        const data = {
                x: 0,
                y: 0,
                height: 600,
                width: 900, 
                imgData: canvas.toDataURL(),
                userID: user,
                roomID: room
            };
        socket.emit("update", data);
        socket.emit("discPlayers", data);
    }

        window.onload = init;
    </script>
</head>
<body>
    <p id="playerRole"></p>
    <p id="correctUsers" >Correct Guessers: </p>
    <canvas id="canvas" width="900" height="600" style="border: 1px solid black; display: inline;"></canvas><br/>
    
    <div class="w3-container" id="inkwell" >
        <h2>Remaining Ink</h2>
        
        <div class="w3-light-grey">
            <div id="emptyInk" class="w3-black" style="height:40px;width:0"></div>
        </div>
    </div>
    
    <h1 id="answer"></h1>
    <p id="firstText"></p>
    <canvas id="firstCanvas" width="900" height="600" style="border: 1px solid black;"></canvas><br/>
    
    <p id="secondText"></p>
    <canvas id="secondCanvas" width="900" height="600" style="border: 1px solid black;"></canvas><br/>
    
    <input type="text" id="guessText" placeholder="Enter guess:" style="visibility: hidden;">
    <input type="button" id="guessButton" value="Enter guess" style="visibility: hidden;">
    <h1 id="voterText"style="visibility: hidden;">What are the drawers attempting to draw?</h1>
    <input type="button" id="startGame" value="Start Game" style="visibility: hidden;">
    <input type="button" id="startNewGame" value="One More Round!" style="visibility: hidden;">
    
    <h1 id="countdownTimer">6</h1>
    <div id="lobbyScreen"></div>
    <h1 id="lobbyText">When all players are ready hit Start Game!</h1>
    <h2 id="lobbySubtext"></h2>
    <div id="advertisment">Advertisment here!</div>
    <div id="roomSelectScreen"></div>
    <h1 id="selectRoomDisplay"></h1>
    <input type="text" id="room" placeholder="Enter room name:">
    <input type="button" id="roomEnter" value="Lock into room">
    <input type="text" id="username" placeholder="Enter username (optional)" maxlength="12">
    <h1 id="titleText">So Little Ink, So Little Time!</h1>
    <h2 id="titleSubtext">Enter room name and username; lock in to continue!</h2>
</body>
</html>